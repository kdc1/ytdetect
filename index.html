<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¬ìƒ íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ì˜ˆì œ</title>
  <style>
    body { font-family: "Noto Sans KR", sans-serif; background-color: #fafafa; color: #333; padding: 2rem; }
    h1, h2 { color: #444; margin: 0; }
    form, .history { margin-bottom: 1.5rem; }
    input[type="text"], textarea { width: 100%; padding: 0.5rem; border: 1px solid #bbb; border-radius: 4px; font-size: 1rem; margin-top: 0.5rem; box-sizing: border-box; }
    input[readonly] { background-color: #eee; }
    button { padding: 0.5rem 1rem; margin: 0; background-color: #0073e6; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    button:hover { background-color: #005bb5; }
    .history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
    .history-header h2 { margin: 0; }
    #clearAllBtn { background-color: #e60000; }
    #clearAllBtn:hover { background-color: #b30000; }
    .history-list { list-style: none; padding: 0; margin: 0; }
    .history-item { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 0.5rem; }
    .history-item > .actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; }
    .actions button { background: transparent; color: #0073e6; padding: 0.25rem 0.5rem; border-radius: 4px; }
    .actions button:hover { background: rgba(0, 115, 230, 0.1); }
    #player { width: 100%; max-width: 560px; height: 315px; background: #000; margin-bottom: 1rem; }
    #statusMessage { color: #d32f2f; font-weight: bold; min-height: 1.2em; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>ì˜ìƒ URL/ID ì…ë ¥ ë° ì¬ìƒ</h1>
  <form id="videoForm">
    <input type="text" id="videoInput" placeholder="ìœ íŠœë¸Œ ì˜ìƒ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" required />
    <button type="submit">ì¬ìƒ</button>
  </form>
  <div id="statusMessage"></div>
  <div id="player"></div>

  <div class="history-header">
    <h2>ì¬ìƒ íˆìŠ¤í† ë¦¬</h2>
    <button id="clearAllBtn">ì „ì²´ ì‚­ì œ</button>
  </div>
  <ul class="history-list" id="historyList"></ul>

  <script>
    var tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    var player, apiReady = false;

    function onYouTubeIframeAPIReady() { apiReady = true; }
    document.getElementById("videoForm").addEventListener("submit", function(e) {
      e.preventDefault();
      var input = document.getElementById("videoInput").value.trim();
      var videoId = extractVideoID(input);
      if (!videoId) { displayMessage("âš ï¸ ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
      playVideo(videoId);
    });

    function extractVideoID(urlOrId) {
      var regExp = /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#&?]{11}).*/;
      var match = urlOrId.match(regExp);
      if (match) return match[1];
      if (/^[A-Za-z0-9_-]{11}$/.test(urlOrId)) return urlOrId;
      return null;
    }

    function playVideo(id) {
      clearMessage();
      if (!apiReady) { displayMessage("ğŸ”„ YouTube API ë¡œë“œ ì¤‘..."); return; }
      if (!player) {
        player = new YT.Player('player', { videoId: id, playerVars: { rel: 0, modestbranding: 1 }, events: { onReady: function(e) { e.target.playVideo(); saveHistory(id); }, onError: showError } });
      } else { player.loadVideoById(id); saveHistory(id); }
    }

    function showError(e) {
      var code = e.data;
      if (code===101||code===150) displayMessage("âš ï¸ ì™¸ë¶€ ì¬ìƒ ë¶ˆê°€ ì˜ìƒì…ë‹ˆë‹¤.");
      else if (code===100) displayMessage("âš ï¸ ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë¹„ê³µê°œì…ë‹ˆë‹¤.");
      else displayMessage("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (Code: " + code + ")");
    }

    function displayMessage(msg) { document.getElementById('statusMessage').textContent = msg; }
    function clearMessage() { document.getElementById('statusMessage').textContent = ''; }

    var STORAGE_KEY = 'playedVideos';

    function loadHistory() {
      var list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      renderHistory(list);
    }

    function saveHistory(videoId) {
      var list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      var url = 'https://www.youtube.com/watch?v=' + videoId;
      // ê¸°ì¡´ ë©”ëª¨/ì œëª© ë³´ì¡´
      var existing = list.find(item => item.id === videoId) || { title: '', note: '' };
      // ì¤‘ë³µ ì œê±° ë° ìƒˆ í•­ëª© ì¶”ê°€
      list = list.filter(item => item.id !== videoId);
      list.unshift({ id: videoId, url: url, title: existing.title, note: existing.note });
      if (list.length > 50) list.pop();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      renderHistory(list);
      // ìœ íŠœë¸Œ ì œëª© ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
      fetch('https://www.youtube.com/oembed?url=' + encodeURIComponent(url) + '&format=json')
        .then(r => r.json())
        .then(data => {
          list[0].title = data.title;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
          renderHistory(list);
        })
        .catch(err => console.error('ì œëª© ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜', err));
    }

    function renderHistory(list) {
      var container = document.getElementById('historyList'); container.innerHTML = '';
      list.forEach((item, idx) => {
        var li = document.createElement('li'); li.className = 'history-item';
        li.innerHTML = `
          <div><strong>URL:</strong> <a href="${item.url}" target="_blank">${item.url}</a></div>
          <div><label>ì œëª©: <input type=\"text\" data-idx=\"${idx}\" class=\"title-field\" value=\"${item.title}\" placeholder=\"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...\" readonly/></label></div>
          <div><label>ë©”ëª¨: <textarea data-idx=\"${idx}\" class=\"note-field\" placeholder=\"ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”\">${item.note}</textarea></label></div>
          <div class="actions">
            <button class="play-btn" data-id="${item.id}">ì¬ìƒ</button>
            <button class="copy-btn" data-url="${item.url}">ë³µì‚¬</button>
            <button class="delete-btn" data-idx="${idx}">ì‚­ì œ</button>
          </div>`;
        container.appendChild(li);
      });
      attachHistoryHandlers();
    }

    function attachHistoryHandlers() {
      document.querySelectorAll('.play-btn').forEach(btn => btn.onclick = function() { playVideo(this.dataset.id); });
      document.querySelectorAll('.copy-btn').forEach(btn => btn.onclick = function() { navigator.clipboard.writeText(this.dataset.url); });
      document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = function() {
        var idx = parseInt(this.dataset.idx,10), list = JSON.parse(localStorage.getItem(STORAGE_KEY));
        list.splice(idx,1); localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); renderHistory(list);
      });
      document.querySelectorAll('.note-field').forEach(area => area.onchange = saveField);
    }

    function saveField(e) {
      var list = JSON.parse(localStorage.getItem(STORAGE_KEY));
      var idx = parseInt(this.dataset.idx,10);
      if (this.classList.contains('note-field')) list[idx].note = this.value;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // ì „ì²´ ì‚­ì œ ì´ë²¤íŠ¸
    document.getElementById('clearAllBtn').addEventListener('click', function() {
      if (confirm('ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem(STORAGE_KEY);
        renderHistory([]);
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    loadHistory();
  </script>
</body>
</html>
