<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>재생 히스토리 관리 예제</title>
  <style>
    body { font-family: "Noto Sans KR", sans-serif; background-color: #fafafa; color: #333; padding: 2rem; }
    h1, h2 { color: #444; margin: 0; }
    form, .history { margin-bottom: 1.5rem; }
    input[type="text"], textarea { width: 100%; padding: 0.5rem; border: 1px solid #bbb; border-radius: 4px; font-size: 1rem; margin-top: 0.5rem; box-sizing: border-box; }
    input[readonly] { background-color: #eee; }
    button { padding: 0.5rem 1rem; margin: 0; background-color: #0073e6; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    button:hover { background-color: #005bb5; }
    .history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
    .history-header h2 { margin: 0; }
    #clearAllBtn { background-color: #e60000; }
    #clearAllBtn:hover { background-color: #b30000; }
    .history-list { list-style: none; padding: 0; margin: 0; }
    .history-item { background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 1rem; margin-bottom: 0.5rem; }
    .history-item > .actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; justify-content: flex-end; }
    .actions button { background: transparent; color: #0073e6; padding: 0.25rem 0.5rem; border-radius: 4px; }
    .actions button:hover { background: rgba(0, 115, 230, 0.1); }
    #player { width: 100%; max-width: 560px; height: 315px; background: #000; margin-bottom: 1rem; }
    #statusMessage { color: #d32f2f; font-weight: bold; min-height: 1.2em; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>영상 URL/ID 입력 및 재생</h1>
  <form id="videoForm">
    <input type="text" id="videoInput" placeholder="유튜브 영상 URL 또는 ID를 입력하세요" required />
    <button type="submit">재생</button>
  </form>
  <div id="statusMessage"></div>
  <div id="player"></div>

  <div class="history-header">
    <h2>재생 히스토리</h2>
    <button id="clearAllBtn">전체 삭제</button>
  </div>
  <ul class="history-list" id="historyList"></ul>

  <script>
    var tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    var player, apiReady = false;

    function onYouTubeIframeAPIReady() { apiReady = true; }
    document.getElementById("videoForm").addEventListener("submit", function(e) {
      e.preventDefault();
      var input = document.getElementById("videoInput").value.trim();
      var videoId = extractVideoID(input);
      if (!videoId) { displayMessage("⚠️ 올바른 유튜브 URL 또는 ID를 입력해주세요."); return; }
      playVideo(videoId);
    });

    function extractVideoID(urlOrId) {
      var regExp = /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#&?]{11}).*/;
      var match = urlOrId.match(regExp);
      if (match) return match[1];
      if (/^[A-Za-z0-9_-]{11}$/.test(urlOrId)) return urlOrId;
      return null;
    }

    function playVideo(id) {
      clearMessage();
      if (!apiReady) { displayMessage("🔄 YouTube API 로드 중..."); return; }
      if (!player) {
        player = new YT.Player('player', { videoId: id, playerVars: { rel: 0, modestbranding: 1 }, events: { onReady: function(e) { e.target.playVideo(); saveHistory(id); }, onError: showError } });
      } else { player.loadVideoById(id); saveHistory(id); }
    }

    function showError(e) {
      var code = e.data;
      if (code===101||code===150) displayMessage("⚠️ 외부 재생 불가 영상입니다.");
      else if (code===100) displayMessage("⚠️ 영상을 찾을 수 없거나 비공개입니다.");
      else displayMessage("⚠️ 알 수 없는 오류 (Code: " + code + ")");
    }

    function displayMessage(msg) { document.getElementById('statusMessage').textContent = msg; }
    function clearMessage() { document.getElementById('statusMessage').textContent = ''; }

    var STORAGE_KEY = 'playedVideos';

    function loadHistory() {
      var list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      renderHistory(list);
    }

    function saveHistory(videoId) {
      var list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      var url = 'https://www.youtube.com/watch?v=' + videoId;
      // 기존 메모/제목 보존
      var existing = list.find(item => item.id === videoId) || { title: '', note: '' };
      // 중복 제거 및 새 항목 추가
      list = list.filter(item => item.id !== videoId);
      list.unshift({ id: videoId, url: url, title: existing.title, note: existing.note });
      if (list.length > 50) list.pop();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      renderHistory(list);
      // 유튜브 제목 자동 불러오기
      fetch('https://www.youtube.com/oembed?url=' + encodeURIComponent(url) + '&format=json')
        .then(r => r.json())
        .then(data => {
          list[0].title = data.title;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
          renderHistory(list);
        })
        .catch(err => console.error('제목 불러오기 오류', err));
    }

    function renderHistory(list) {
      var container = document.getElementById('historyList'); container.innerHTML = '';
      list.forEach((item, idx) => {
        var li = document.createElement('li'); li.className = 'history-item';
        li.innerHTML = `
          <div><strong>URL:</strong> <a href="${item.url}" target="_blank">${item.url}</a></div>
          <div><label>제목: <input type=\"text\" data-idx=\"${idx}\" class=\"title-field\" value=\"${item.title}\" placeholder=\"불러오는 중...\" readonly/></label></div>
          <div><label>메모: <textarea data-idx=\"${idx}\" class=\"note-field\" placeholder=\"메모를 입력하세요\">${item.note}</textarea></label></div>
          <div class="actions">
            <button class="play-btn" data-id="${item.id}">재생</button>
            <button class="copy-btn" data-url="${item.url}">복사</button>
            <button class="delete-btn" data-idx="${idx}">삭제</button>
          </div>`;
        container.appendChild(li);
      });
      attachHistoryHandlers();
    }

    function attachHistoryHandlers() {
      document.querySelectorAll('.play-btn').forEach(btn => btn.onclick = function() { playVideo(this.dataset.id); });
      document.querySelectorAll('.copy-btn').forEach(btn => btn.onclick = function() { navigator.clipboard.writeText(this.dataset.url); });
      document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = function() {
        var idx = parseInt(this.dataset.idx,10), list = JSON.parse(localStorage.getItem(STORAGE_KEY));
        list.splice(idx,1); localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); renderHistory(list);
      });
      document.querySelectorAll('.note-field').forEach(area => area.onchange = saveField);
    }

    function saveField(e) {
      var list = JSON.parse(localStorage.getItem(STORAGE_KEY));
      var idx = parseInt(this.dataset.idx,10);
      if (this.classList.contains('note-field')) list[idx].note = this.value;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // 전체 삭제 이벤트
    document.getElementById('clearAllBtn').addEventListener('click', function() {
      if (confirm('모든 히스토리를 삭제하시겠습니까?')) {
        localStorage.removeItem(STORAGE_KEY);
        renderHistory([]);
      }
    });

    // 초기 로드
    loadHistory();
  </script>
</body>
</html>
